<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${exam.title}"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f0f8ff;
        }
        .exam-card {
            background-color: #ffffff;
            border-radius: 1rem;
            box-shadow: 0 8px 25px rgba(0,0,0,0.07);
        }
        .exam-header {
            background-color: #e0f7fa;
            color: #004d40;
            padding: 1.5rem;
            border-top-left-radius: 1rem;
            border-top-right-radius: 1rem;
            border-bottom: 1px solid #b2ebf2;
        }
        .question-block {
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .question-block:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .question-text {
            font-weight: 500;
            color: #333;
        }
        .timer-container {
            position: sticky;
            top: 80px; /* Adjust based on header height */
            z-index: 1000;
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .timer-text {
            font-size: 1.25rem;
            font-weight: 700;
            color: #007bff;
        }
        .progress {
            height: 10px;
        }
        .btn-success {
            font-weight: 500;
            padding: 0.75rem 1.5rem;
        }
    </style>
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<main class="container mt-5 mb-5">
    <div class="timer-container">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <strong>Оставшееся время:</strong>
            <span id="timer" class="timer-text">--:--</span>
        </div>
        <div class="progress">
            <div id="timer-progress" class="progress-bar bg-primary" role="progressbar" style="width: 100%" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
    </div>

    <div class="card exam-card">
        <div class="exam-header">
            <h2 th:text="${exam.title}" class="mb-0"></h2>
        </div>
        <div class="card-body p-4 p-md-5">
            <form id="exam-form" th:action="@{'/candidate/exam/' + ${exam.id} + '/submit'}" method="post">
                <div th:each="question, iterStat : ${exam.questions}" class="question-block">
                    <h5 class="question-text" th:text="${(iterStat.index + 1) + '. ' + question.text}"></h5>
                    <div th:each="answer : ${question.answers}" class="form-check mt-3">
                        <input class="form-check-input" type="radio" th:name="'question_' + ${question.id}"
                               th:id="'answer_' + ${answer.id}" th:value="${answer.id}">
                        <label class="form-check-label" th:for="'answer_' + ${answer.id}" th:text="${answer.text}"></label>
                    </div>
                </div>

                <div class="text-center mt-5">
                    <button type="submit" class="btn btn-success btn-lg">Завершить экзамен</button>
                </div>
            </form>
        </div>
    </div>
</main>

<div th:replace="fragments/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const durationMinutes = /*[[${exam.durationMinutes}]]*/ 60; // Получаем длительность из модели
    const examForm = document.getElementById('exam-form');
    const timerDisplay = document.getElementById('timer');
    const timerProgressBar = document.getElementById('timer-progress');

    let totalSeconds = durationMinutes * 60;

    const timer = setInterval(() => {
        totalSeconds--;

        if (totalSeconds < 0) {
            clearInterval(timer);
            // alert('Время вышло! Экзамен будет завершен автоматически.');
            examForm.submit(); // Автоматическая отправка формы
            return;
        }

        // Расчет оставшегося времени
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;

        // Форматирование вывода
        timerDisplay.textContent =
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

        // Обновление прогресс-бара
        const percentage = (totalSeconds / (durationMinutes * 60)) * 100;
        timerProgressBar.style.width = percentage + '%';

        if (percentage < 25) {
            timerProgressBar.classList.remove('bg-primary');
            timerProgressBar.classList.add('bg-danger');
        } else if (percentage < 50) {
            timerProgressBar.classList.remove('bg-primary');
            timerProgressBar.classList.add('bg-warning');
        }

    }, 1000);
    /*]]>*/
</script>
</body>
</html>